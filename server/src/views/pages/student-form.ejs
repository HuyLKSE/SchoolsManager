<%- include('../partials/dashboard-layout-header', { title: title }) %>

<section class="space-y-6">
  <!-- Header with Back Button -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="/students" class="p-2 hover:bg-gray-100 rounded-lg">
        <%- icon('arrow-left', 'h-5 w-5') %>
      </a>
      <div>
        <h1 class="text-2xl font-bold"><%= title %></h1>
        <p class="text-sm text-text-muted">Điền đầy đủ thông tin học sinh</p>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <div class="bg-white rounded-xl shadow-sm p-6">
    <form id="studentForm" onsubmit="submitForm(event)" class="space-y-6">
      
      <!-- Basic Information -->
      <div>
        <h3 class="text-lg font-semibold mb-4 pb-2 border-b">Thông tin cơ bản</h3>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Họ và tên *
            </label>
            <input type="text" id="fullName" name="fullName" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Nhập họ và tên đầy đủ">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Mã học sinh *
            </label>
            <input type="text" id="studentCode" name="studentCode" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Nhập mã học sinh">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Ngày sinh *
            </label>
            <input type="date" id="dateOfBirth" name="dateOfBirth" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Giới tính *
            </label>
            <select id="gender" name="gender" required 
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
              <option value="">-- Chọn giới tính --</option>
              <option value="male">Nam</option>
              <option value="female">Nữ</option>
              <option value="other">Khác</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div>
        <h3 class="text-lg font-semibold mb-4 pb-2 border-b">Thông tin liên hệ</h3>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Địa chỉ
            </label>
            <input type="text" id="address" name="address" 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Nhập địa chỉ đầy đủ">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Số điện thoại
            </label>
            <input type="tel" id="phone" name="phone" 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Số điện thoại liên hệ">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Email
            </label>
            <input type="email" id="email" name="email" 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Nhập email">
          </div>
        </div>
      </div>

      <!-- Guardian Information -->
      <div>
        <h3 class="text-lg font-semibold mb-4 pb-2 border-b">Thông tin phụ huynh</h3>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Tên phụ huynh
            </label>
            <input type="text" id="guardianName" name="guardianName" 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Họ tên phụ huynh">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Số điện thoại phụ huynh
            </label>
            <input type="tel" id="guardianPhone" name="guardianPhone" 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Số điện thoại phụ huynh">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Email phụ huynh
            </label>
            <input type="email" id="guardianEmail" name="guardianEmail" 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                   placeholder="Nhập email phụ huynh">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Quan hệ
            </label>
            <select id="guardianRelationship" name="guardianRelationship" 
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
              <option value="">-- Chọn quan hệ --</option>
              <option value="father">Bố</option>
              <option value="mother">Mẹ</option>
              <option value="grandparent">Ông/Bà</option>
              <option value="other">Khác</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Academic Information -->
      <div>
        <h3 class="text-lg font-semibold mb-4 pb-2 border-b">Thông tin học tập</h3>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Lớp học
            </label>
            <select id="classId" name="classId" 
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
              <option value="">-- Chọn lớp --</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Trạng thái *
            </label>
            <select id="status" name="status" required 
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500">
              <option value="active">Đang học</option>
              <option value="suspended">Đình chỉ</option>
              <option value="transferred">Chuyển trường</option>
              <option value="graduated">Đã tốt nghiệp</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Ghi chú
            </label>
            <textarea id="notes" name="notes" rows="3" 
                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500"
                      placeholder="Ghi chú thêm về học sinh"></textarea>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex gap-3 pt-4 border-t">
        <a href="/students" class="flex-1 px-4 py-2 border rounded-lg text-center hover:bg-gray-50">
          Hủy
        </a>
        <button type="submit" id="submitBtn" 
                class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50">
          <% if (mode === 'create') { %>
            Thêm học sinh
          <% } else { %>
            Lưu thay đổi
          <% } %>
        </button>
      </div>
    </form>
  </div>
</section>

<script>
  const mode = '<%= mode %>';
  const studentId = '<%= student?._id || "" %>';
  
  // Load classes for dropdown
  async function loadClasses() {
    try {
      const res = await fetch('/api/v1/classes?limit=1000&status=active', { credentials: 'include' });
      if (res.ok) {
        const data = await res.json();
        const select = document.getElementById('classId');
        select.innerHTML = '<option value="">-- Chọn lớp --</option>';
        if (data.data && Array.isArray(data.data)) {
          data.data.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls._id;
            option.textContent = cls.className || cls.name || cls.classCode;
            select.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Lỗi tải danh sách lớp:', error);
    }
  }

  // Load student data if editing
  async function loadStudentData() {
    if (mode !== 'edit' || !studentId) return;
    
    try {
      const res = await fetch(`/api/v1/students/${studentId}`, { credentials: 'include' });
      if (res.ok) {
        const data = await res.json();
        const student = data.data;
        
        // Fill form fields
        document.getElementById('fullName').value = student.fullName || '';
        document.getElementById('studentCode').value = student.studentCode || '';
        document.getElementById('dateOfBirth').value = student.dateOfBirth?.split('T')[0] || '';
        document.getElementById('gender').value = student.gender || '';
        document.getElementById('address').value = student.address || '';
        document.getElementById('phone').value = student.phone || '';
        document.getElementById('email').value = student.email || '';
        
        // Guardian info
        if (student.guardian) {
          document.getElementById('guardianName').value = student.guardian.name || '';
          document.getElementById('guardianPhone').value = student.guardian.phone || '';
          document.getElementById('guardianEmail').value = student.guardian.email || '';
          document.getElementById('guardianRelationship').value = student.guardian.relationship || '';
        }
        
        // Academic info
        document.getElementById('classId').value = student.classId?._id || student.classId || '';
        document.getElementById('status').value = student.status || 'active';
        document.getElementById('notes').value = student.notes || '';
        
        // Disable studentCode in edit mode
        document.getElementById('studentCode').readOnly = true;
        document.getElementById('studentCode').classList.add('bg-gray-100');
      } else {
        alert('Không thể tải thông tin học sinh');
        window.location.href = '/students';
      }
    } catch (error) {
      console.error('Lỗi tải thông tin học sinh:', error);
      alert('Lỗi kết nối đến server');
    }
  }

  // Submit form
  async function submitForm(event) {
    event.preventDefault();
    
    const formData = {
      fullName: document.getElementById('fullName').value.trim(),
      studentCode: document.getElementById('studentCode').value.trim(),
      dateOfBirth: document.getElementById('dateOfBirth').value,
      gender: document.getElementById('gender').value,
      address: document.getElementById('address').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      email: document.getElementById('email').value.trim(),
      guardian: {
        name: document.getElementById('guardianName').value.trim(),
        phone: document.getElementById('guardianPhone').value.trim(),
        email: document.getElementById('guardianEmail').value.trim(),
        relationship: document.getElementById('guardianRelationship').value
      },
      classId: document.getElementById('classId').value || null,
      status: document.getElementById('status').value,
      notes: document.getElementById('notes').value.trim()
    };

    // Validate required fields
    if (!formData.fullName || !formData.studentCode || !formData.dateOfBirth || !formData.gender) {
      alert('Vui lòng điền đầy đủ các trường bắt buộc (*)');
      return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Đang xử lý...';

    try {
      const url = mode === 'create' 
        ? '/api/v1/students' 
        : `/api/v1/students/${studentId}`;
      
      const method = mode === 'create' ? 'POST' : 'PUT';

      const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        alert(mode === 'create' ? '✅ Thêm học sinh thành công' : '✅ Cập nhật thông tin thành công');
        window.location.href = '/students';
      } else {
        const error = await res.json();
        alert('❌ Lỗi: ' + (error.error?.message || 'Không thể lưu thông tin'));
        submitBtn.disabled = false;
        submitBtn.textContent = mode === 'create' ? 'Thêm học sinh' : 'Lưu thay đổi';
      }
    } catch (error) {
      console.error('Lỗi submit form:', error);
      alert('❌ Lỗi kết nối đến server');
      submitBtn.disabled = false;
      submitBtn.textContent = mode === 'create' ? 'Thêm học sinh' : 'Lưu thay đổi';
    }
  }

  // Initialize
  loadClasses();
  if (mode === 'edit') {
    loadStudentData();
  }
</script>

<%- include('../partials/dashboard-layout-footer') %>
