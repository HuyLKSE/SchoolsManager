<%- include('../partials/dashboard-layout-header', { title: 'Chi tiết lớp học' }) %>

<section class="space-y-6">
  <div class="section-heading">
    <div>
      <a href="/classes" class="inline-flex items-center gap-1 text-sm text-text-muted hover:text-primary-600 mb-2">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Quay lại danh sách
      </a>
      <h2 class="text-2xl font-bold" id="className">Đang tải...</h2>
      <p class="text-sm text-text-muted" id="classInfo">--</p>
    </div>
    <% if (user && user.hasPermission && user.hasPermission('canUpdate')) { %>
      <a href="/classes/<%= classId %>/edit" class="btn btn-primary">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Chỉnh sửa
      </a>
    <% } %>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="card">
    <div class="animate-pulse space-y-4">
      <div class="h-6 bg-gray-200 rounded w-1/4"></div>
      <div class="h-4 bg-gray-200 rounded w-1/2"></div>
      <div class="h-4 bg-gray-200 rounded w-3/4"></div>
    </div>
  </div>

  <!-- Content -->
  <div id="contentArea" class="hidden space-y-6">
    <!-- Class Info Cards -->
    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <div class="stat-card">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-primary-50 text-primary-600">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
        </div>
        <div>
          <p class="stat-label">Tổng số học sinh</p>
          <p class="stat-value" id="totalStudents">--</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-success/10 text-success">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <p class="stat-label">Sĩ số khả dụng</p>
          <p class="stat-value" id="availableSeats">--</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-warning/10 text-warning">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div>
          <p class="stat-label">GVCN</p>
          <p class="stat-value text-base" id="teacher">--</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-secondary-50 text-secondary-500">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
        </div>
        <div>
          <p class="stat-label">Phòng học</p>
          <p class="stat-value text-base" id="classroom">--</p>
        </div>
      </div>
    </div>

    <!-- Class Details Card -->
    <div class="card space-y-4">
      <h3 class="text-lg font-semibold">Thông tin chi tiết</h3>
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <p class="text-sm text-text-muted mb-1">Mã lớp</p>
          <p class="font-semibold" id="classCode">--</p>
        </div>
        <div>
          <p class="text-sm text-text-muted mb-1">Khối</p>
          <p class="font-semibold" id="grade">--</p>
        </div>
        <div>
          <p class="text-sm text-text-muted mb-1">Trạng thái</p>
          <span id="statusBadge" class="badge">--</span>
        </div>
        <div>
          <p class="text-sm text-text-muted mb-1">Năm học</p>
          <p class="font-semibold" id="academicYear">--</p>
        </div>
        <div class="md:col-span-2">
          <p class="text-sm text-text-muted mb-1">Workspace</p>
          <div class="flex items-center gap-2">
            <code class="text-xs bg-gray-100 px-2 py-1 rounded" id="workspacePath">--</code>
            <span id="workspaceBadge" class="badge badge-warning">Đang kiểm tra...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Students List -->
    <div class="card space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Danh sách học sinh</h3>
        <input type="text" id="searchStudent" placeholder="Tìm học sinh..." class="form-control max-w-xs">
      </div>
      
      <div id="studentsList" class="space-y-2">
        <div class="empty-state">
          <p>Đang tải danh sách học sinh...</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const classId = '<%= classId %>';
  let classData = null;

  async function loadClassData() {
    try {
      const response = await fetch(`/api/v1/classes/${classId}`, {
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Không thể tải thông tin lớp học');
      }

      const result = await response.json();
      classData = result.data;
      
      renderClassInfo();
      loadStudents();
    } catch (error) {
      document.getElementById('loadingState').innerHTML = `
        <div class="empty-state text-danger">
          <p>${error.message}</p>
          <a href="/classes" class="btn btn-secondary mt-4">Quay lại danh sách</a>
        </div>
      `;
    }
  }

  function renderClassInfo() {
    document.getElementById('className').textContent = classData.name || classData.className || '--';
    document.getElementById('classInfo').textContent = `Khối ${classData.grade || '--'} • ${classData.classCode || '--'}`;
    
    document.getElementById('totalStudents').textContent = classData.currentStudents || 0;
    document.getElementById('availableSeats').textContent = `${(classData.capacity || 0) - (classData.currentStudents || 0)}/${classData.capacity || '--'}`;
    document.getElementById('teacher').textContent = classData.homeroomTeacher?.fullName || 'Chưa phân công';
    document.getElementById('classroom').textContent = classData.classroom || 'Chưa phân phòng';
    
    document.getElementById('classCode').textContent = classData.classCode || '--';
    document.getElementById('grade').textContent = `Khối ${classData.grade || '--'}`;
    document.getElementById('academicYear').textContent = classData.academicYear || '--';
    
    const statusClass = {
      'Đang hoạt động': 'badge badge-success',
      'Đã kết thúc': 'badge badge-info',
      'Tạm ngưng': 'badge badge-warning',
    }[classData.status] || 'badge';
    
    const statusBadge = document.getElementById('statusBadge');
    statusBadge.className = statusClass;
    statusBadge.textContent = classData.status || '--';
    
    const workspacePath = document.getElementById('workspacePath');
    const workspaceBadge = document.getElementById('workspaceBadge');
    
    if (classData.workspace?.path) {
      workspacePath.textContent = classData.workspace.path;
      workspaceBadge.className = 'badge badge-success';
      workspaceBadge.textContent = `✓ ${classData.workspace.code}`;
    } else {
      workspacePath.textContent = 'Chưa khởi tạo';
      workspaceBadge.className = 'badge badge-warning';
      workspaceBadge.textContent = 'Chưa đồng bộ';
    }
    
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('contentArea').classList.remove('hidden');
  }

  async function loadStudents() {
    try {
      const response = await fetch(`/api/v1/classes/${classId}/students`, {
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Không thể tải danh sách học sinh');
      }

      const result = await response.json();
      renderStudents(result.data);
    } catch (error) {
      document.getElementById('studentsList').innerHTML = `
        <div class="empty-state text-danger">
          <p>${error.message}</p>
        </div>
      `;
    }
  }

  function renderStudents(students) {
    const list = document.getElementById('studentsList');
    
    if (!students || students.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <p>Chưa có học sinh nào trong lớp.</p>
        </div>
      `;
      return;
    }

    list.innerHTML = students.map((student, index) => `
      <div class="flex items-center justify-between p-3 rounded-xl border border-border hover:bg-gray-50 transition-colors">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary-100 text-primary-600 font-semibold">
            ${index + 1}
          </div>
          <div>
            <p class="font-semibold">${student.fullName}</p>
            <p class="text-sm text-text-muted">${student.studentCode || '--'}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span class="badge ${student.status === 'Đang học' ? 'badge-success' : 'badge-info'}">
            ${student.status || '--'}
          </span>
          <a href="/students/${student._id}" class="btn btn-sm btn-secondary">
            <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          </a>
        </div>
      </div>
    `).join('');
  }

  // Search functionality
  document.getElementById('searchStudent').addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const studentItems = document.querySelectorAll('#studentsList > div');
    
    studentItems.forEach(item => {
      const text = item.textContent.toLowerCase();
      item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });

  // Load data on page load
  loadClassData();
</script>

<%- include('../partials/dashboard-layout-footer') %>
